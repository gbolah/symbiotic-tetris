<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Symbiotic Tetris</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: radial-gradient(circle at center, rgba(0, 255, 136, 0.25), rgba(0,0,0,0.95));
      font-family: Arial, sans-serif;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      overflow: hidden;
    }
    h1 {
      font-size: 60px;
      margin-bottom: 10px;
      color: #00ff88;
      text-shadow: 0 0 10px #00ff88, 0 0 20px #00ff88;
    }
    #overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      background: rgba(0,0,0,0.6);
      z-index: 2;
    }
    #overlay input {
      padding: 10px;
      margin-top: 15px;
      font-size: 18px;
      border-radius: 8px;
      border: 1px solid #00ff88;
      text-align: center;
    }
    button {
      margin-top: 20px;
      padding: 12px 24px;
      font-size: 20px;
      cursor: pointer;
      border: none;
      border-radius: 10px;
      background: #00ff88;
      color: black;
      font-weight: bold;
      box-shadow: 0 0 15px #00ff88;
    }
    button:hover {
      background: #00cc6f;
    }
    canvas {
      border: 2px solid #00ff88;
      box-shadow: 0 0 20px #00ff88;
      background: #111;
    }
  </style>
</head>
<body>
  <h1>Symbiotic Tetris</h1>
  <div id="overlay">
    <p>Enter a username to start</p>
    <input type="text" id="usernameInput" placeholder="Username"/>
    <button onclick="saveUsername()">Save & Play</button>
  </div>

  <canvas id="tetris" width="360" height="720"></canvas>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // Supabase setup
    const SUPABASE_URL = "https://jzofwfixzsotrcmrxlsx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp6b2Z3Zml4enNvdHJjbXJ4bHN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMTczODcsImV4cCI6MjA3Mzg5MzM4N30.zgV7-3R0cuopTtw8caZaYnkM5Mxg1bphJzkuvZGuf-8";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const canvas = document.getElementById("tetris");
    const ctx = canvas.getContext("2d");
    const overlay = document.getElementById("overlay");
    const usernameInput = document.getElementById("usernameInput");

    const COLS = 12, ROWS = 24, BLOCK = 30;
    canvas.width = COLS * BLOCK;
    canvas.height = ROWS * BLOCK;

    let board = Array.from({ length: ROWS }, () => Array(COLS).fill(0));
    let pieces = "TJLOSZI";
    let colors = {
      T: "#ff00ff", J: "#0000ff", L: "#ff8800",
      O: "#ffff00", S: "#00ff00", Z: "#ff0000", I: "#00ffff"
    };

    let dropInterval = 800, lastDrop = 0;
    let piece = null;
    let score = 0, highScore = 0;
    let username = localStorage.getItem("username") || null;
    let gameRunning = false;

    if (username) {
      usernameInput.value = username;
      overlay.innerHTML = `<p>Welcome back, <b>${username}</b></p><p>Press SPACE to start</p>`;
      loadHighScore();
    }

    function randomPiece() {
      const type = pieces[Math.floor(Math.random() * pieces.length)];
      if (type === "T") return { matrix:[[0,1,0],[1,1,1]], color:colors.T, x:4,y:0 };
      if (type === "J") return { matrix:[[1,0,0],[1,1,1]], color:colors.J, x:4,y:0 };
      if (type === "L") return { matrix:[[0,0,1],[1,1,1]], color:colors.L, x:4,y:0 };
      if (type === "O") return { matrix:[[1,1],[1,1]], color:colors.O, x:5,y:0 };
      if (type === "S") return { matrix:[[0,1,1],[1,1,0]], color:colors.S, x:4,y:0 };
      if (type === "Z") return { matrix:[[1,1,0],[0,1,1]], color:colors.Z, x:4,y:0 };
      if (type === "I") return { matrix:[[1,1,1,1]], color:colors.I, x:4,y:0 };
    }

    function drawMatrix(matrix, offset, color) {
      ctx.fillStyle = color;
      matrix.forEach((row, y) => row.forEach((val, x) => {
        if (val) ctx.fillRect((x+offset.x)*BLOCK,(y+offset.y)*BLOCK,BLOCK-1,BLOCK-1);
      }));
    }

    function collide(matrix, pos) {
      return matrix.some((row,y) => row.some((val,x) => {
        return val && (board[y+pos.y] && board[y+pos.y][x+pos.x]) !== 0;
      }));
    }

    function merge(matrix, pos, color) {
      matrix.forEach((row,y) => row.forEach((val,x) => {
        if (val) board[y+pos.y][x+pos.x] = color;
      }));
    }

    function rotate(matrix) {
      return matrix[0].map((_, i) => matrix.map(row => row[i])).reverse();
    }

    function drawBoard() {
      ctx.fillStyle = "#111";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      board.forEach((row,y) => row.forEach((val,x) => {
        if (val) {
          ctx.fillStyle = val;
          ctx.fillRect(x*BLOCK,y*BLOCK,BLOCK-1,BLOCK-1);
        }
      }));
    }

    function drop() {
      piece.y++;
      if (collide(piece.matrix,piece)) {
        piece.y--;
        merge(piece.matrix,piece,piece.color);
        clearRows();
        piece = randomPiece();
        if (collide(piece.matrix,piece)) gameOver();
      }
    }

    function clearRows() {
      outer: for (let y = ROWS-1; y >= 0; y--) {
        if (board[y].every(v => v)) {
          board.splice(y,1);
          board.unshift(Array(COLS).fill(0));
          score += 100;
        }
      }
    }

    function update(time=0) {
      if (!gameRunning) return;
      const delta = time - lastDrop;
      if (delta > dropInterval) {
        drop();
        lastDrop = time;
      }
      drawBoard();
      drawMatrix(piece.matrix,piece,piece.color);
      ctx.fillStyle="white";
      ctx.font="20px Arial";
      ctx.fillText("Score: "+score,20,30);
      ctx.fillText("High Score: "+highScore,20,60);
      requestAnimationFrame(update);
    }

    function gameOver() {
      gameRunning = false;
      saveHighScore();
      overlay.style.display="flex";
      overlay.innerHTML = `<h1>Game Over</h1><p>Score: ${score}</p><p>High Score: ${highScore}</p><button onclick="startGame()">Restart</button>`;
    }

    function startGame() {
      overlay.style.display="none";
      board = Array.from({ length: ROWS }, () => Array(COLS).fill(0));
      piece = randomPiece();
      score=0;
      gameRunning=true;
      requestAnimationFrame(update);
    }

    function saveUsername() {
      username = usernameInput.value.trim();
      if (!username) return alert("Enter username!");
      localStorage.setItem("username", username);
      overlay.innerHTML = `<p>Welcome, <b>${username}</b></p><p>Press SPACE to start</p>`;
      loadHighScore();
    }

    async function loadHighScore() {
      let { data } = await supabase.from("wall").select("highscore").eq("user", username).single();
      highScore = data ? data.highscore : 0;
    }

    async function saveHighScore() {
      if (score > highScore) {
        highScore=score;
        await supabase.from("wall").upsert({ user: username, highscore: highScore });
      }
    }

    document.addEventListener("keydown", e => {
      if (!gameRunning && e.code==="Space" && username) startGame();
      else if (gameRunning) {
        if (e.code==="ArrowLeft"){ piece.x--; if (collide(piece.matrix,piece)) piece.x++; }
        else if (e.code==="ArrowRight"){ piece.x++; if (collide(piece.matrix,piece)) piece.x--; }
        else if (e.code==="ArrowUp"){ let m=rotate(piece.matrix); if (!collide(m,piece)) piece.matrix=m; }
        else if (e.code==="ArrowDown"){ drop(); }
      }
    });

    window.saveUsername = saveUsername;
    window.startGame = startGame;
  </script>
</body>
</html>
